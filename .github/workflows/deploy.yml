name: Deploy to Cloud on push main

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy
      cancel-in-progress: true

    steps:
      - name: Connect & deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            # ==========================================
            # çŽ¯å¢ƒé…ç½® (Environment Setup)
            # ==========================================
            APP_DIR="${{ secrets.SERVER_PATH }}"
            PID_FILE="$APP_DIR/bot.pid"
            LOG_FILE="$APP_DIR/bot.log"

            # æ˜¾å¼åŠ è½½ uv è·¯å¾„ (è§£å†³ .bashrc éžäº¤äº’æ¨¡å¼ä¸åŠ è½½çš„é—®é¢˜)
            export PATH=$PATH:$HOME/.local/bin

            # æ‰“å°è°ƒè¯•ä¿¡æ¯
            echo "=== DEBUG INFO ==="
            echo "uv location: $(which uv)"
            echo "uv version: $(uv --version)"
            echo "=================="

            # ==========================================
            # ä»£ç æ›´æ–° (Update Code)
            # ==========================================
            cd "$APP_DIR"

            echo "ðŸ”„ Fetching latest code..."
            git remote -v
            git fetch --all
            git reset --hard origin/main

            # ==========================================
            # ä¾èµ–åŒæ­¥ (Sync Dependencies)
            # ==========================================
            echo "ðŸ“¦ Syncing dependencies with uv..."
            uv sync

            # ==========================================
            # åœæ­¢æ—§è¿›ç¨‹ (Stop Old Process with Graceful Shutdown)
            # ==========================================
            echo "ðŸ›‘ Checking for running process..."
            if [ -f "$PID_FILE" ]; then
              OLD_PID="$(cat "$PID_FILE" || true)"
              if [ -n "$OLD_PID" ] && kill -0 "$OLD_PID" >/dev/null 2>&1; then
                echo "Stopping old process: $OLD_PID"
                kill "$OLD_PID" || true

                # æœ€å¤šç­‰ 10 ç§’è®©è¿›ç¨‹ä¼˜é›…é€€å‡º
                for i in $(seq 1 10); do
                  if kill -0 "$OLD_PID" >/dev/null 2>&1; then
                    sleep 1
                  else
                    break
                  fi
                done

                # è‹¥è¿˜æ´»ç€å°±å¼ºæ€
                if kill -0 "$OLD_PID" >/dev/null 2>&1; then
                  echo "Force killing $OLD_PID"
                  kill -9 "$OLD_PID" || true
                fi
              fi
              rm -f "$PID_FILE"
            else
              echo "No PID file found. Skipping stop."
            fi

            # ==========================================
            # å¯åŠ¨æ–°è¿›ç¨‹ (Start New Process)
            # ==========================================
            echo "âœ… Starting new bot process..."
            nohup uv run python -m bot > "$LOG_FILE" 2>&1 &
            NEW_PID=$!
            echo "$NEW_PID" > "$PID_FILE"

            echo "ðŸŽ‰ Bot started successfully with PID: $NEW_PID"
            echo "ðŸ“„ Logs are being written to: $LOG_FILE"

name: Deploy to Remote Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            # ==========================================
            # 1. çŽ¯å¢ƒé…ç½® (Environment Setup)
            # ==========================================
            # æ˜¾å¼åŠ è½½ uv è·¯å¾„ (è§£å†³ .bashrc éžäº¤äº’æ¨¡å¼ä¸åŠ è½½çš„é—®é¢˜)
            export PATH=$PATH:$HOME/.local/bin
            
            # å®šä¹‰å…³é”®å˜é‡
            SERVER_PATH="${{ secrets.SERVER_PATH }}"
            PID_FILE="$SERVER_PATH/bot.pid"
            LOG_FILE="$SERVER_PATH/bot.log"

            # ==========================================
            # 2. ä»£ç æ›´æ–° (Update Code)
            # ==========================================
            # è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œå¦‚æžœç›®å½•ä¸å­˜åœ¨åˆ™æŠ¥é”™é€€å‡º
            cd "$SERVER_PATH" || { echo "Directory not found!"; exit 1; }

            echo "ðŸš€ Pulling latest code..."
            git pull origin main

            # ==========================================
            # 3. ä¾èµ–åŒæ­¥ (Sync Dependencies)
            # ==========================================
            echo "ðŸ“¦ Syncing dependencies with uv..."
            uv sync

            # ==========================================
            # 4. åœæ­¢æ—§è¿›ç¨‹ (Stop Old Process via PID)
            # ==========================================
            echo "ðŸ›‘ Checking for running process..."
            if [ -f "$PID_FILE" ]; then
                OLD_PID=$(cat "$PID_FILE")
                echo "Found PID file: $OLD_PID"
                
                # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨ (kill -0 ä¸å‘é€ä¿¡å·ï¼Œåªæ£€æŸ¥)
                if kill -0 "$OLD_PID" 2>/dev/null; then
                    echo "Killing process $OLD_PID..."
                    kill "$OLD_PID"
                    # ç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡º (å¯é€‰)
                    sleep 2
                else
                    echo "Process $OLD_PID is not running."
                fi
                # åˆ é™¤æ—§çš„ PID æ–‡ä»¶
                rm "$PID_FILE"
            else
                echo "No PID file found. Skipping stop."
            fi

            # ==========================================
            # 5. å¯åŠ¨æ–°è¿›ç¨‹ (Start New Process)
            # ==========================================
            echo "âœ… Starting new bot process..."
            
            # åŽå°è¿è¡Œï¼Œé‡å®šå‘è¾“å‡ºæ—¥å¿—
            nohup uv run python -m bot > "$LOG_FILE" 2>&1 &
            
            # èŽ·å–åˆšåˆšå¯åŠ¨çš„è¿›ç¨‹ ID ($!) å¹¶å†™å…¥æ–‡ä»¶
            NEW_PID=$!
            echo "$NEW_PID" > "$PID_FILE"
            
            echo "ðŸŽ‰ Bot started successfully with PID: $NEW_PID"
            echo "ðŸ“„ Logs are being written to: $LOG_FILE"
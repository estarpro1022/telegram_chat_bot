name: Deploy to Remote Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            # echo PATH
            echo $PATH | tr ':' '\n'

            # 添加 uv 到 PATH（根据实际安装路径调整）
            export PATH=$PATH:/home/kartone/.local/bin

            # 设置变量
            SERVER_PATH="${{ secrets.SERVER_PATH }}"

            # 进入项目目录
            cd "$SERVER_PATH" || exit 1

            # 拉取最新代码
            echo "Pulling latest code..."
            git pull origin main

            # 同步依赖
            echo "Syncing dependencies with uv..."
            uv sync

            # 重启服务 (停止旧进程，启动新进程)
            echo "Restarting bot service..."

            # 查找并停止旧进程, [b]正则防止杀掉自己
            pkill -f "python -m [b]ot" || true
            sleep 2

            # 启动新进程 (后台运行)
            nohup uv run python -m bot > bot.log 2>&1 &

            echo "Deployment completed successfully!"
            echo "Bot is running in background. Check logs with: tail -f $SERVER_PATH/bot.log"
